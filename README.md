# Сервис авторизации

## API

### POST /auth/login

1. Принимает на вход идентификатор пользователя.
2. Получает из параметров запроса IP-адрес пользователя.
3. Проверяет, что пользователь с указанным идентификатором существует в БД.
4. Проверяет, что в таблице AUTHS нет записи с идентификатором пользователя, если есть - удаляет ее.
5. Создает предварительную запись в таблице AUTHS, получает ее идентификатор (AuthId).
6. Создает ACCESS токен, подписывает его ключом для ACCESS токена.
7. Создает REFRESH токен, подписывает его ключом для REFRESH токена.
8. Вычисляет значение bcrypt хэш-функции для REFRESH токена и обновляет поле REFRESH_TOKEN_KEY записи в таблице AUTHS с идентификатором AuthId.
9. Возвращает пользователю модель с двумя токенами.

### POST /auth/refresh

1. Принимает на вход модель, содержащую ACCESS и REFRESH токены.
2. Получает из параметров запроса IP-адрес пользователя.
3. Декодирует токены, проверяет их подписи.
4. Возвращает ошибку, если поля `jti` токенов не совпадают.
5. Отправляет предупреждение на почту пользователя, если текущий IP адрес не совпадает с полем `address` ACCESS токена.
6. По идентификатору токена получает запись из таблицы REFRESH, проверяет, что поле VALUE совпадает со значением bcrypt хэш-функции для REFRESH токена и удаляет запись.
7. Создает предварительную запись в таблице REFRESH, получает ее идентификатор (AuthId).
8. Создает ACCESS токен, подписывает его ключом для ACCESS токена.
9. Создает REFRESH токен, подписывает его ключом для REFRESH токена.
10. Вычисляет значение bcrypt хэш-функции для REFRESH токена и обновляет поле VALUE записи в таблице REFRESH с идентификатором AuthId.
11. Возвращает пользователю модель с двумя токенами.

## Токены

1. ACCESS и REFRESH токены связаны обоюдно через идентификатор, единый для обоих токенов.
2. Защита REFRESH токена от изменений обеспечивается подписью ключом, отличным от ключа ACCESS токена.

### ACCESS

1. Тип: JWT,
2. Алгоритм: SHA512,
3. Время жизни: 15 минут.

```json
{
    "header": {
        "alg": "HS512", 
        "typ": "JWT"
    },
    "payload": {
        "iss": "shumilija/goauth", // Издатель токена
        "iat": 0, // Момент времени, в который токен был выдан.
        "exp": 0, // Момент времени, до которого токен считается действительным.
        "jti": "token-id", // Идентификатор токена. Один на пару ACCESS + REFRESH.
        "sub": "user-id", // Идентификатор пользователя, которому был выдан токен.
        "address: "127.0.0.1" // IP-адрес пользователя.
    }
}
```

### REFRESH

1. Тип: JWT,
2. Алгоритм: SHA512,
3. Время жизни: 24 часа.

```json
{
    "header": {
        "alg": "HS512", 
        "typ": "JWT"
    },
    "payload": {
        "iss": "shumilija/goauth", // Издатель токена
        "iat": 0, // Момент времени, в который токен был выдан.
        "exp": 0, // Момент времени, до которого токен считается действительным.
        "jti": "token-id", // Идентификатор токена. Один на пару ACCESS + REFRESH.
    }
}
```

## База данных

### Таблица USERS

Содержит сведения о пользователях.

```sql
CREATE TABLE USERS (
    ID SERIAL PRIMARY KEY, -- Идентификатор пользователя.
    EMAIL CHARACTER VARYING(30) -- Адрес электронной почты пользователя.
)
```

### Таблица AUTHS

Содержит сведения об аутентификациях пользователей.

```sql
CREATE TABLE AUTHS (
    ID SERIAL PRIMARY KEY, -- Идентификатор записи об аутентификации.
    USER_ID INTEGER REFERENCES USERS (ID), -- Идентификатор пользователя, которому была выдана пара токенов.
    REFRESH_TOKEN_HASH CHARACTER VARYING(100) -- BCRYPT хэш от REFRESH токена.
)
```
